# Nom du workflow qui appara√Ætra dans l'onglet "Actions" de GitHub
name: üê≥ Build and Publish Docker Image

# D√©clencheur : s'ex√©cute uniquement lors d'un "push" sur la branche "main"
on:
  push:
    branches: [ "main" ]

# T√¢ches √† ex√©cuter
jobs:
  build-and-publish:
    # Utilise la derni√®re version d'Ubuntu comme machine virtuelle
    runs-on: ubuntu-latest
    
    # --- PERMISSIONS TR√àS IMPORTANTES ---
    # Ces permissions sont n√©cessaires pour que l'action puisse
    # 1. Lire le contenu du repository (contents: read)
    # 2. √âcrire dans le registre de packages (packages: write)
    permissions:
      contents: read
      packages: write

    # √âtapes du job
    steps:
      # 1. R√©cup√®re le code de votre repository
      - name: Check out the repo
        uses: actions/checkout@v4

      # 2. Se connecte au registre de conteneurs de GitHub (ghcr.io)
      # (Utilise un GITHUB_TOKEN temporaire et s√©curis√©)
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. √âtape qui g√©n√®re automatiquement les "tags" (√©tiquettes)
      # pour l'image Docker (ex: "latest", nom de la branche, etc.)
      # et s'assure que tout est en minuscules.
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}

      # 4. Construit l'image Docker (en utilisant votre Dockerfile)
      # et la pousse (publie) sur ghcr.io
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: . # Indique que le Dockerfile est √† la racine
          push: true # Indique qu'il faut publier l'image
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
